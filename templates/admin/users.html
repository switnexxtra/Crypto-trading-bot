{% extends "base.html" %}

{% block content %}

    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />

    <!-- <link rel="stylesheet" href="../css/users_dashboard.css"> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/users_dashboard.css') }}">


    <div class="wrapper d-flex align-items-stretch">

        <nav id="sidebar" class="active">
            <h1><a href="{{url_for('main.home')}}" class="logo">M.</a></h1>
            <ul class="list-unstyled components mb-5 mt-5">
                <li class="active">
                    <a href="{{url_for('admin.dashboard')}}" class="text-decoration-none"><span class="fa fa-home"></span>
                        Home</a>
                </li>
                <li>
                    <a href="{{url_for('admin.investment')}}" class="text-decoration-none"
                        >
                        <span class="fa fa-handshake"></span>
                        Investment
                    </a>
                </li>
                <li>
                    <a href="{{url_for('admin.loan')}}" class="text-decoration-none"><span class="fa fa-money"></span> Loan</a>
                </li>
                <li>
                    <a href="{{url_for('admin.transactions')}}" class="text-decoration-none"><span class="fa fa-book"></span>
                        Transaction history</a>
                </li>
                <li>
                    <a href="{{url_for('admin.users')}}" class="text-success text-decoration-none" style="background-color: #FFFFFF; opacity: .7; border-radius:3px;">
                        <span class="fa fa-user-md"></span>
                        Users
                    </a>
                </li>
                <li>
                    <a href="{{url_for('admin.kyc')}}" class="text-decoration-none"><span class="fa fa-users"></span> Kyc</a>
                </li>
        
                <li>
                    <a href="{{url_for('admin.support')}}" class="text-decoration-none"><span class="fa fa-support"></span>
                        Support</a>
                </li>
                <li>
                    <a href="{{url_for('auth.logout')}}" class="text-decoration-none"><span class="fa fa-sign-out"></span>
                        Logout</a>
                </li>
            </ul>
        
        </nav>



        <!-- Page Content  -->
        <div id="content" class="p-4 p-md-5">

            <div class="profile-container d-flex justify-content-between align-items-center">
                <div class="text-center">
                    <p class="pt-2 user-name">Hello, <span> {{ user.username }}! </span></p>
                </div>

                <div class="d-flex align-items-center ms-auto">
                    <i class="fa fa-bell fa-lg mx-2"></i>
                    <i class="fa fa-envelope fa-lg mx-2"></i>
                    <i class="fa fa-cog fa-lg mx-2"></i>
                    {% if user.gender == 'male' %}
                    <img src="{{ url_for('static', filename='img/male1.png') }}" class="rounded-circle l-bg-cherry" width="40" height="40"
                        alt="Profile">
                    {% elif user.gender == 'female' %}
                    <img src="{{ url_for('static', filename='img/female.png') }}" class="rounded-circle l-bg-pink" width="40" height="40"
                        alt="Profile">
                    {% else %}
                    <img src="{{ url_for('static', filename='img/gender.png') }}" class="rounded-circle l-bg-orange" width="40" height="40"
                        alt="Profile">
                    {% endif %}
                </div>
            </div>


            <!-- Nav Content  -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">

                    <button type="button" id="sidebarCollapse" class="btn toggle-btn">
                        <i class="fa fa-bars"></i>
                        <span class="sr-only">Toggle Menu</span>
                    </button>

                    <div class="align-items-center text-center justify-content-center">
                        <p class="pt-2 pr-3 balance">Balance: <span>$20k </span></p>
                    </div>
                </div>
            </nav>


            <!-- Transaction section -->
            <div class="container refferal_container">

                <h5 class="all_refferals text-center">
                    All  Users
                </h5>

                <!-- Search Bar -->
                <div class="mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search users by username, email, or ID..."
                        onkeyup="searchUsers()">
                </div>
                <div class="container py-3">
                    <div class="row">
                        <div class="col-lg-12 mx-auto bg-white rounded shadow p-3">

                            <!-- Table with fixed header and scrolling body -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-fixed" >
                                    <thead class="thead primary-bg-color">
                                        <tr class="primary-bg-color">
                                            <th scope="col">#</th>
                                            <th scope="col">UID</th>
                                            <th scope="col">Username</th>
                                            <th scope="col">Email</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        {% for account in users %}
                                            {% if account.is_admin == False %}
                                                <tr>
                                                    <th scope="row">{{ account.id }} </th>
                                                    <td>{{ account.user_id }}</td>
                                                    <td>{{ account.username }}</td>
                                                    <td>{{ account.email }}</td>
                                                    <td>
                                                        {% if account.status is none or account.status == 'None' %}
                                                        <p class="l-bg-green text-light p-2 mt-4 d-inline">None</p>
                                                        {% elif account.status == 'active' %}
                                                        <p class="l-bg-green text-light p-2 mt-4 d-inline">Active</p>
                                                        {% elif account.status == 'pending' %}
                                                        <p class="bg-warning text-dark p-2 mt-4 d-inline">Pending</p>
                                                        {% elif account.status == 'verified' %}
                                                        <p class="bg-success text-light p-2 mt-4 d-inline">Verified</p>
                                                        {% else %}
                                                        <p class="bg-secondary text-light p-2 mt-4 d-inline">{{ user.status }}</p>
                                                        {% endif %}
                                                    </td>
                                    
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <!-- Ensure each button targets the correct modal -->
                                                            <button class="btn l-bg-pink text-white" data-bs-toggle="modal" data-bs-target="#editUserModal{{ account.id }}">
                                                                Details
                                                            </button>

                                                            <button class="btn l-bg-green text-white" data-bs-toggle="modal" data-bs-target="#sendNotificationModal">
                                                                Send Notification
                                                            </button>


                                                            {% if user.status == 'active' %}
                                                            <button class="btn btn-danger text-white p-1">Deactivate</button>
                                                            {% elif user.status == 'pending' %}
                                                            <button class="btn btn-warning text-white p-1">Pending</button>
                                                            {% elif user.status == 'suspend' %}
                                                            <button class="btn l-bg-cyan text-white p-1">Unsuspend</button>
                                                            {% elif user.status == 'verified' %}
                                                            <button class="btn btn-success text-white p-1">Verified</button>
                                                            {% else %}
                                                            <button class="btn btn-success text-white p-1">Activate</button>
                                                            {% endif %}

                                                        </div>

                                                    </td>
                                                </tr>
                                            
                                    </tbody>
                                </table>

                                <!-- Send Notification Modal -->
                                <div class="modal fade" id="sendNotificationModal" tabindex="-1" aria-labelledby="sendNotificationModalLabel"
                                    aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="sendNotificationModalLabel">Send Notification</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form action="{{ url_for('admin.send_notification') }}" method="POST">
                                                    <div class="mb-3">
                                                        <label for="message" class="form-label">Notification Message</label>
                                                        <textarea name="message" id="message" class="form-control" required></textarea>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Details Modal -->
                                <div class="modal fade" id="editUserModal{{ account.id }}" tabindex="-1" aria-labelledby="editUserModalLabel"
                                    aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">User Details</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                
                                            <form method="POST" action="{{ url_for('admin.update_user', user_id=account.id) }}">
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <!-- Personal Info -->
                                                        <div class="col-md-6">
                                                            <h6>Personal Info</h6>
                                                            <div class="mb-2">
                                                                <label class="form-label">Full Name</label>
                                                                <input type="text" class="form-control" name="fullname" value="{{ account.fullname }}"
                                                                    required>
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Username</label>
                                                                <input type="text" class="form-control" name="username" value="{{ account.username }}"
                                                                    required>
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Email</label>
                                                                <input type="email" class="form-control" name="email" value="{{ account.email }}"
                                                                    required>
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Mobile</label>
                                                                <input type="text" class="form-control" name="mobile" value="{{ account.mobile }}">
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Date of Birth</label>
                                                                <input type="text" class="form-control" name="dateofbirth"
                                                                    value="{{ account.dateofbirth }}" required>
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Gender</label>
                                                                <select class="form-select" name="gender">
                                                                    <option value="Male" {% if account.gender=='Male' %} selected {% endif %}>
                                                                        Male</option>
                                                                    <option value="Female" {% if account.gender=='Female' %} selected {% endif %}>Female
                                                                    </option>
                                                                    <option value="Other" {% if account.gender=='Other' %} selected {% endif %}>
                                                                        Other</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                
                                                        <!-- Address Info -->
                                                        <div class="col-md-6">
                                                            <h6>Address Info</h6>
                                                            <div class="mb-2">
                                                                <label class="form-label">Line 1</label>
                                                                <input type="text" class="form-control" name="line1" value="{{ account.line1 }}">
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Line 2</label>
                                                                <input type="text" class="form-control" name="line2" value="{{ account.line2 }}">
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Country</label>
                                                                <input type="text" class="form-control" name="country" value="{{ account.country }}">
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">City</label>
                                                                <input type="text" class="form-control" name="city" value="{{ account.city }}">
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Region</label>
                                                                <input type="text" class="form-control" name="region" value="{{ account.region }}">
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label">Postal Code</label>
                                                                <input type="text" class="form-control" name="postal" value="{{ account.postal }}">
                                                            </div>
                                                        </div>
                                                    </div>
                                
                                                    <hr>
                                
                                                    <!-- Financial Details -->
                                                    <h6>Financial Details</h6>
                                                    <div class="mb-2">
                                                        <label class="form-label">Wallet ID</label>
                                                        <input type="text" class="form-control" name="wallet_id" value="{{ account.wallet_id }}"
                                                            readonly>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label">Balance</label>
                                                        <input type="text" class="form-control" name="balance" value="{{ account.balance }}">
                                                    </div>
                                
                                                    <div class="mb-2">
                                                        <label class="form-label">Bonus</label>
                                                        <input type="number" class="form-control" name="bonus" value="{{ account.bonus }}">
                                                    </div>
                                
                                                    <div class="mb-2">
                                                        <label class="form-label">Current Plan</label>
                                                        <input type="text" class="form-control" name="current_plan" value="{{ account.current_plan }}"
                                                            readonly>
                                                    </div>
                                
                                                    <div class="mb-2">
                                                        <label class="form-label">Transation pin</label>
                                                        <input type="text" class="form-control" name="transaction_pin"
                                                            value="{{ account.transaction_pin }}" readonly>
                                                    </div>
                                
                                                    <div class="mb-2">
                                                        <label class="form-label">Status</label>
                                                        <select class="form-select" name="status">
                                                            <option value="active" {% if account.status=='active' %} selected {% endif %}>Active
                                                            </option>
                                                            <option value="pending" {% if account.status=='pending' %} selected {% endif %}>Pending
                                                            </option>
                                                            <option value="suspend" {% if account.status=='suspend' %} selected {% endif %}>Suspend
                                                            </option>
                                                            <option value="verified" {% if account.status=='verified' %} selected {% endif %}>Verified
                                                            </option>
                                                        </select>
                                                    </div>
                                
                                                    <hr>
                                
                                                    <!-- Transactions -->
                                                    <h6>Transactions</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover table-fixed">
                                                            <thead class="thead primary-bg-color">
                                                                <tr>
                                                                    <th>Transaction ID</th>
                                                                    <th>Type</th>
                                                                    <th>Details</th>
                                                                    <th>Amount</th>
                                                                    <th>Status</th>
                                                                    <th>Date</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for transaction in account.transactions %}
                                                                <tr>
                                                                    <td>{{ transaction.transaction_id }}</td>
                                                                    <td>{{ transaction.transaction_type }}</td>
                                                                    <td>{{ transaction.transaction_detail }}</td>
                                                                    <td>${{ transaction.amount }}</td>
                                                                    <td>
                                                                        {% if transaction.status in ["Pending", "pending"] %}
                                                                        <p class="bg-warning text-dark p-2 d-inline">Pending</p>
                                                                        {% elif transaction.status in ["Completed", "completed"] %}
                                                                        <p class="bg-success text-white p-2 d-inline">Completed</p>
                                                                        {% elif transaction.status in ["Failed", "failed"] %}
                                                                        <p class="bg-danger text-white p-2 d-inline">Failed</p>
                                                                        {% else %}
                                                                        <p class="bg-secondary text-white p-2 d-inline">{{ transaction.status }}</p>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>{{ transaction.created_at.strftime('%Y-%m-%d') }}</td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn l-bg-teal text-white">Save Changes</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                {% endif %}
                                {% endfor %}
                            </div> <!-- End -->

                            
                        </div>
                    </div>

                </div>

                <!-- Toast Notification -->
                <div class="toast-container">
                    <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert"
                        aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                Copied to clipboard!
                            </div>
                            <button type="button" class="btn-close btn-light  m-auto text-light" data-bs-dismiss="toast"
                                aria-label="Close"></button>
                        </div>
                    </div>
                </div>



                


            </div>
            <!-- Bootstrap CSS -->
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

            <!-- jQuery (for dynamic content) -->
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

            <!-- Bootstrap JS (for modal) -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

            <!-- <script src="js/jquery.min.js"></script>
            <script src="js/popper.js"></script>
            <script src="js/bootstrap.min.js"></script>-->
            <script>
                function searchUsers() {
                        const searchValue = document.getElementById('searchInput').value;

                        // Only proceed if there's a search term or if clearing the search
                        if (searchValue || searchValue === '') {
                            fetch(`/admin/search_users?q=${encodeURIComponent(searchValue)}`)
                                .then(response => response.text())  // Get response as HTML text
                                .then(html => {
                                    document.getElementById('userTableBody').innerHTML = html;

                                    // Re-initialize any Bootstrap components if needed
                                    // For example, if you have tooltips:
                                    // var tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                                    // tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
                                })
                                .catch(error => {
                                    console.error('Error searching users:', error);
                                });
                        }
                    }

            </script> 

    
{% endblock %}